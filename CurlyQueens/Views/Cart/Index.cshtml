@model CurlyQueens.ViewModels.CartViewModel

@{
    ViewData["Title"] = "Shopping Cart";
    Layout = "_Layout";
}

<div class="container py-5">
    <h2 class="text-center mb-4" style="color:#800020;">
        <i class="fas fa-shopping-cart"></i> Shopping Cart
    </h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Items.Any())
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0" style="border-radius:15px;">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead style="background-color:#800020; color:white;">
                                    <tr>
                                        <th>Image</th>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Subtotal</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Items)
                                    {
                                        <tr data-product-id="@item.ProductId">
                                            <td>
                                                <img src="~/Images/@System.IO.Path.GetFileName(@item.ImageUrl)" 
                                                     alt="@item.ProductName" 
                                                     onerror="this.src='~/Images/default.jpg'"
                                                     style="width:80px;height:80px;object-fit:cover;border-radius:10px;" />
                                            </td>
                                            <td>
                                                <strong>@item.ProductName</strong>
                                            </td>
                                            <td>
                                                <span class="text-muted">@item.Price.ToString("C")</span>
                                            </td>
                                            <td>
                                                <div class="input-group" style="width:120px;">
                                                    <button class="btn btn-sm btn-outline-secondary btn-decrease" 
                                                            data-product-id="@item.ProductId">
                                                        <i class="fas fa-minus"></i>
                                                    </button>
                                                    <input type="number" class="form-control text-center quantity-input" 
                                                           value="@item.Quantity" min="1" 
                                                           data-product-id="@item.ProductId" />
                                                    <button class="btn btn-sm btn-outline-secondary btn-increase" 
                                                            data-product-id="@item.ProductId">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td>
                                                <strong class="item-subtotal">@item.SubTotal.ToString("C")</strong>
                                            </td>
                                            <td>
                                                <button class="btn btn-danger btn-sm btn-remove" 
                                                        data-product-id="@item.ProductId">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <form asp-action="Clear" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt"></i> Clear Cart
                        </button>
                    </form>
                    <a asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Continue Shopping
                    </a>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0" style="border-radius:15px; position:sticky; top:100px;">
                    <div class="card-header text-white text-center" style="background-color:#800020; border-radius:15px 15px 0 0;">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Items:</span>
                            <strong id="cart-item-count">@Model.GetItemCount()</strong>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Total:</h5>
                            <h5 class="text-success" id="cart-total">@Model.GetTotal().ToString("C")</h5>
                        </div>
                        <a href="#" class="btn w-100 text-white" style="background-color:#d4af37;">
                            <i class="fas fa-credit-card"></i> Checkout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart" style="font-size:100px; color:#ccc;"></i>
            <h3 class="mt-3 text-muted">Your Cart is Empty</h3>
            <p class="text-muted">You haven't added any products to your cart yet</p>
            <a asp-controller="Product" asp-action="Index" class="btn text-white mt-3" style="background-color:#800020;">
                <i class="fas fa-shopping-bag"></i> Browse Products
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Increase quantity button
            $('.btn-increase').click(function() {
                var productId = $(this).data('product-id');
                var input = $(`input[data-product-id="${productId}"]`);
                var newQuantity = parseInt(input.val()) + 1;
                updateQuantity(productId, newQuantity);
            });

            // Decrease quantity button
            $('.btn-decrease').click(function() {
                var productId = $(this).data('product-id');
                var input = $(`input[data-product-id="${productId}"]`);
                var currentQuantity = parseInt(input.val());
                if (currentQuantity > 1) {
                    var newQuantity = currentQuantity - 1;
                    updateQuantity(productId, newQuantity);
                }
            });

            // Direct input change
            $('.quantity-input').change(function() {
                var productId = $(this).data('product-id');
                var newQuantity = parseInt($(this).val());
                if (newQuantity > 0) {
                    updateQuantity(productId, newQuantity);
                }
            });

            // Remove product from cart
            $('.btn-remove').click(function() {
                if (confirm('Are you sure you want to remove this product?')) {
                    var productId = $(this).data('product-id');
                    $.ajax({
                        url: '@Url.Action("RemoveFromCart", "Cart")',
                        type: 'POST',
                        data: { productId: productId },
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        success: function(response) {
                            if (response.success) {
                                $(`tr[data-product-id="${productId}"]`).fadeOut(function() {
                                    $(this).remove();
                                    updateCartUI(response.cartItemCount, 0);
                                    if ($('tbody tr').length === 0) {
                                        location.reload();
                                    }
                                });
                            }
                        }
                    });
                }
            });

            // Update quantity via AJAX
            function updateQuantity(productId, quantity) {
                $.ajax({
                    url: '@Url.Action("UpdateQuantity", "Cart")',
                    type: 'POST',
                    data: { productId: productId, quantity: quantity },
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            $(`input[data-product-id="${productId}"]`).val(quantity);
                            $(`tr[data-product-id="${productId}"] .item-subtotal`).text(
                                '$' + response.subTotal.toFixed(2)
                            );
                            updateCartUI(response.cartItemCount, response.total);
                        }
                    }
                });
            }

            // Update UI
            function updateCartUI(itemCount, total) {
                $('#cart-item-count').text(itemCount);
                $('#navbar-cart-count').text(itemCount);
                if (total > 0) {
                    $('#cart-total').text('$' + total.toFixed(2));
                }
            }
        });
    </script>
}
